<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planillas Avantix One</title>
    <meta name="description" content="Sistema profesional de gesti√≥n de planillas y control de horas para empresas.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=27.0">
    <link rel="stylesheet" href="calculator.css?v=27.0">
    <link rel="icon" type="image/png" href="img/favicon.png?v=3">

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="img/icons/icon-192x192.png">

    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; img-src 'self' data: blob:; connect-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com;">
    <script src="https://unpkg.com/lucide@0.575.0/dist/umd/lucide.js"></script>
</head>

<body>
    <!-- Vista de Landing Page -->
    <div id="landing-view" class="landing-screen" style="display: none;">
        <!-- Se inyectar√° din√°micamente desde main.js -->
    </div>

    <!-- Vista de Login -->
    <div id="login-view" class="login-screen" style="display: none;">
        <div class="login-card">
            <img src="img/avantix_one_logo.png" alt="Avantix One Logo" style="height: 100px; margin-bottom: 1.5rem;">
            <p style="color: var(--text-muted); margin-bottom: 1rem;">Sistema de Control de Planillas</p>

            <div id="login-error" class="login-error">
                Usuario o contrase√±a incorrectos.
            </div>

            <div id="login-mode-selector"
                style="display: flex; gap: 10px; margin-bottom: 2rem; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 12px;">
                <button class="btn" id="btn-mode-admin"
                    style="flex: 1; font-size: 0.85rem; background: var(--primary); color: white;">Administrador</button>
                <button class="btn" id="btn-mode-emp"
                    style="flex: 1; font-size: 0.85rem; background: transparent; color: var(--text-muted);">Soy
                    Empleado</button>
            </div>

            <form class="login-form" id="login-form">
                <!-- Campos para Admin -->
                <div id="admin-fields">
                    <div class="login-input-group">
                        <label>Usuario</label>
                        <input type="text" id="username" placeholder="admin">
                    </div>
                    <div class="login-input-group">
                        <label>Contrase√±a</label>
                        <div class="password-wrapper">
                            <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <button type="button" class="password-toggle" onclick="window.togglePassword('password')"><i
                                    data-lucide="eye" style="width:20px; height:20px"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Campos para Empleado (PIN) -->
                <div id="employee-fields" style="display: none;">
                    <div class="login-input-group">
                        <label>Ingrese su PIN de 4 d√≠gitos</label>
                        <input type="password" id="employee-pin" placeholder="0000" maxlength="4" inputmode="numeric"
                            style="text-align: center; font-size: 1.5rem; letter-spacing: 12px;">
                    </div>
                </div>

                <button type="submit" class="login-btn" id="submit-login">Entrar al Sistema</button>
            </form>

            <p style="margin-top: 2rem; font-size: 0.8rem; color: var(--text-muted)">
                ¬øNo tienes una cuenta? <a href="https://pay.hotmart.com/L104170872R" id="go-to-register" target="_blank"
                    rel="noopener" style="color: var(--primary); text-decoration: none; font-weight: 600;">Reg√≠strate
                    aqu√≠</a>
            </p>

            <!-- Bot√≥n de Instalaci√≥n PWA -->
            <div id="pwa-install-section" class="pwa-install-container">
                <button id="btn-pwa-install" class="pwa-install-btn">
                    <i data-lucide="smartphone"
                        style="width:20px; height:20px; margin-right:8px; vertical-align:middle"></i> Instalar
                    Aplicaci√≥n Avantix One
                </button>
            </div>

            <p style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-muted)">
                ¬© 2026 Planillas Avantix One
            </p>
        </div>
    </div>

    <!-- Loader Global -->
    <div id="loader-overlay"
        style="display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
        <div class="loader-spinner"></div>
        <div id="loader-text" style="color: white; margin-top: 1.5rem; font-weight: 500; font-size: 1.1rem;">Procesando
            datos...</div>
        <div
            style="width: 300px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 1rem; overflow: hidden;">
            <div id="loader-progress"
                style="width: 0%; height: 100%; background: var(--primary); transition: width 0.3s ease;"></div>
        </div>
    </div>

    <!-- Notificaciones Toast -->
    <div id="toast-container"></div>

    <!-- App Container -->
    <div id="app" style="display: none;">
        <aside class="sidebar" id="sidebar">
            <button class="menu-close" id="menu-close">‚úï</button>
            <div class="logo" style="display: flex; align-items: center; gap: 10px; padding: 1rem;">
                <img src="img/avantix_one_logo.png" alt="Logo" style="height: 40px;">
            </div>
            <nav>
                <button class="nav-item active" data-view="dashboard">
                    <span class="nav-icon"><i data-lucide="layout-dashboard"></i></span> Dashboard
                </button>
                <button class="nav-item" data-view="employees">
                    <span class="nav-icon"><i data-lucide="users"></i></span> Empleados
                </button>
                <button class="nav-item" data-view="users">
                    <span class="nav-icon"><i data-lucide="key"></i></span> Usuarios
                </button>
                <button class="nav-item" data-view="calculator">
                    <span class="nav-icon"><i data-lucide="calculator"></i></span> Calculadora
                </button>
                <button class="nav-item" data-view="payroll">
                    <span class="nav-icon"><i data-lucide="banknote"></i></span> Planillas
                </button>
                <button class="nav-item" data-view="import">
                    <span class="nav-icon"><i data-lucide="download"></i></span> Importar Excel
                </button>
                <button class="nav-item" data-view="profile">
                    <span class="nav-icon"><i data-lucide="settings"></i></span> Configuraci√≥n
                </button>

                <!-- SECCI√ìN PARA SUPER ADMIN -->
                <div id="super-admin-divider"
                    style="display: none; height: 1px; background: rgba(255,255,255,0.1); margin: 1.5rem 1rem 0.5rem 1rem;">
                </div>
                <div id="super-admin-label"
                    style="display: none; padding: 0 1rem; font-size: 0.65rem; font-weight: 700; color: var(--primary); opacity: 0.7; letter-spacing: 1px; margin-bottom: 0.5rem;">
                    <i data-lucide="terminal"
                        style="width:14px; height:14px; margin-right:4px; vertical-align:middle"></i> MODULO
                    DESARROLLADOR
                </div>

                <button class="nav-item" data-view="adminBusinesses" id="nav-admin-businesses" style="display: none;">
                    <span class="nav-icon"><i data-lucide="building-2"></i></span> Empresas
                </button>
                <button class="nav-item" data-view="adminSuperUsers" id="nav-admin-super-users" style="display: none;">
                    <span class="nav-icon"><i data-lucide="user-cog"></i></span> Super Usuarios
                </button>
                <button class="nav-item" data-view="adminStats" id="nav-admin-stats" style="display: none;">
                    <span class="nav-icon"><i data-lucide="trending-up"></i></span> Global Stats
                </button>
                <button class="nav-item" data-view="adminEmailSettings" id="nav-admin-email" style="display: none;">
                    <span class="nav-icon"><i data-lucide="mail"></i></span> Config. Email
                </button>
            </nav>
            <div style="margin-top: auto; padding: 1rem;">
                <button class="btn" id="logout-btn"
                    style="width: 100%; justify-content: center; background: rgba(239, 68, 68, 0.1); color: var(--danger);">
                    <i data-lucide="log-out" style="width: 18px; margin-right: 8px;"></i> Cerrar Sesi√≥n
                </button>
            </div>
            <div class="sidebar-footer">
                <p>¬© 2026 Avantix One</p>
            </div>
        </aside>

        <main class="content">
            <header>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button id="menu-toggle" class="menu-toggle"><i data-lucide="menu"></i></button>
                    <h2 id="view-title">Dashboard</h2>
                </div>
                <div class="user-profile">
                    <button id="header-theme-toggle" class="btn-icon" title="Cambiar Tema"
                        style="margin-right: 1rem; background: var(--hover-bg); border-radius: 12px; padding: 8px;">
                        <span id="theme-icon-sun"><i data-lucide="sun"></i></span>
                        <span id="theme-icon-moon" style="display: none;"><i data-lucide="moon"></i></span>
                    </button>
                    <span class="status-dot"></span>
                    <span class="username">Administrador</span>
                </div>
            </header>

            <div id="view-container">
                <!-- Views will be injected here -->
            </div>
        </main>
    </div>
    <dialog id="employee-modal">
        <div class="modal-content" style="max-height: 85vh; overflow-y: auto;">
            <button class="modal-close-btn" onclick="document.getElementById('employee-modal').close()">‚úï</button>
            <h3 id="modal-title" style="margin-bottom: 1.5rem">Registrar Empleado</h3>
            <form id="employee-form" style="display: flex; flex-direction: column; gap: 15px;">
                <input type="hidden" name="id" id="edit-emp-id">
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" name="name" placeholder="Ej: Juan P√©rez" required>
                </div>
                <div class="form-group">
                    <label>N√∫mero de C√©dula</label>
                    <input type="text" name="cedula" placeholder="Ej: 1-2345-6789">
                </div>
                <div class="form-group">
                    <label>Tel√©fono (WhatsApp)</label>
                    <div class="phone-input-group">
                        <select class="country-code-select" name="phone_prefix">
                            <option value="506" selected>üá®üá∑ +506</option>
                            <option value="507">üáµüá¶ +507</option>
                            <option value="505">üá≥üáÆ +505</option>
                            <option value="504">üá≠üá≥ +504</option>
                            <option value="502">üá¨üáπ +502</option>
                            <option value="503">üá∏üáª +503</option>
                            <option value="1">üá∫üá∏ +1</option>
                            <option value="52">üá≤üáΩ +52</option>
                            <option value="57">üá®üá¥ +57</option>
                            <option value="54">üá¶üá∑ +54</option>
                            <option value="56">üá®üá± +56</option>
                            <option value="51">üáµüá™ +51</option>
                            <option value="34">üá™üá∏ +34</option>
                        </select>
                        <input type="text" name="phone" placeholder="Ej: 88888888">
                    </div>
                </div>
                <div class="form-group">
                    <label>Correo Electr√≥nico (para res√∫menes)</label>
                    <input type="email" name="email" placeholder="ejemplo@correo.com">
                </div>
                <div class="form-group"
                    style="background: rgba(99,102,241,0.05); padding: 1rem; border-radius: 8px; border: 1px solid rgba(99,102,241,0.3);">
                    <label style="color: var(--primary); font-weight: 600;">üîê PIN de Acceso al Portal (4
                        d√≠gitos)</label>
                    <input type="text" name="pin" placeholder="Ej: 1234" maxlength="4" pattern="[0-9]*"
                        inputmode="numeric" style="margin-top: 0.5rem;">
                    <small
                        style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-top: 0.5rem;">Este
                        PIN permite al empleado registrar sus horas en el portal de auto-servicio</small>
                </div>
                <div class="grid-2" style="gap: 1rem">
                    <div class="form-group">
                        <label>Cargo</label>
                        <input type="text" name="position" placeholder="Ej: Chef" required>
                    </div>
                    <div class="form-group">
                        <label>Pago por Hora (‚Ç°)</label>
                        <input type="number" name="hourlyRate" placeholder="3500" required>
                    </div>
                </div>
                <div class="grid-2" style="gap: 1rem">
                    <div class="form-group">
                        <label>Estado</label>
                        <select name="status">
                            <option value="Active">Activo</option>
                            <option value="Inactive">Inactivo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha Inicio</label>
                        <input type="date" name="startDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Fecha Terminaci√≥n (Opcional)</label>
                    <input type="date" name="endDate">
                </div>
                <div class="form-group"
                    style="display: flex; align-items: center; gap: 10px; background: rgba(99,102,241,0.05); padding: 10px; border-radius: 8px; border: 1px solid rgba(99,102,241,0.2); margin-bottom: 0.5rem;">
                    <input type="checkbox" name="applyCCSS" id="apply-ccss-check"
                        style="width: 20px; height: 20px; cursor: pointer;">
                    <label for="apply-ccss-check" style="margin: 0; cursor: pointer; font-weight: 600;">Aplicar
                        Rebajo CCSS</label>
                </div>

                <div class="form-group"
                    style="background: rgba(99,102,241,0.05); padding: 10px; border-radius: 8px; border: 1px solid rgba(99,102,241,0.2); margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" name="enableOvertime" id="enable-ot-check"
                            style="width: 20px; height: 20px; cursor: pointer;" checked>
                        <label for="enable-ot-check"
                            style="margin: 0; cursor: pointer; font-weight: 600; color: var(--primary);">Habilitar
                            C√°lculo de Horas Extras</label>
                    </div>
                </div>

                <div class="grid-2"
                    style="gap: 1rem; background: rgba(99,102,241,0.05); padding: 1rem; border-radius: 8px; border: 1px solid rgba(99,102,241,0.2);">
                    <div class="form-group">
                        <label title="Horas m√°ximas antes de empezar a pagar extras">L√≠mite Horas Extra
                            (Semanales)</label>
                        <input type="number" name="overtimeThreshold" placeholder="48" step="0.5">
                    </div>
                    <div class="form-group">
                        <label title="N√∫mero por el que se multiplica el pago (ej: 1.5 es tiempo y medio)">Multiplicador
                            Extra (Ej: 1.5)</label>
                        <input type="number" name="overtimeMultiplier" placeholder="1.5" step="0.1">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex:1">Guardar</button>
                    <button type="button" class="btn btn-secondary" style="flex:1"
                        onclick="document.getElementById('employee-modal').close()">Cancelar</button>
                </div>
            </form>

            <!-- SECCI√ìN DE VALES (Dentro del perfil) -->
            <div id="employee-vouchers-section"
                style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; display: none;">
                <h4 style="color: var(--warning); margin-bottom: 1rem;"><i data-lucide="ticket"
                        style="width:18px; margin-right:8px; vertical-align:middle"></i> Vales y Adelantos Pendientes
                </h4>
                <div class="table-container"
                    style="background: rgba(245, 158, 11, 0.03); border: 1px solid rgba(245, 158, 11, 0.1); border-radius: 12px; padding: 10px;">
                    <table style="font-size: 0.85rem;">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Descripci√≥n</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="emp-profile-vouchers-body">
                            <!-- Vouchers here -->
                        </tbody>
                    </table>
                </div>

                <div
                    style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px dashed rgba(255,255,255,0.1);">
                    <h5 style="margin-top: 0; margin-bottom: 10px; font-size: 0.85rem; color: var(--text-muted);"><i
                            data-lucide="plus" style="width:14px; margin-right:6px; vertical-align:middle"></i>
                        Agregar Nuevo Vale</h5>
                    <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                        <input type="date" id="profile-voucher-date" style="padding: 6px; font-size: 0.85rem; flex: 1;">
                        <input type="text" id="profile-voucher-desc" placeholder="Descripci√≥n"
                            style="padding: 6px; font-size: 0.85rem; flex: 2;">
                        <input type="number" id="profile-voucher-amount" placeholder="Monto"
                            style="padding: 6px; font-size: 0.85rem; flex: 1;">
                        <button type="button" class="btn btn-primary" style="padding: 8px 15px; font-size: 0.85rem;"
                            id="profile-add-voucher-btn">Agregar</button>
                    </div>
                </div>
            </div>
        </div>
    </dialog>

    <dialog id="payroll-detail-modal">
        <div class="modal-content" style="max-width: 1100px; max-height: 85vh; overflow-y: auto;">
            <button class="modal-close-btn" onclick="document.getElementById('payroll-detail-modal').close()">‚úï</button>
            <h3 id="payroll-detail-title" style="margin-bottom: 1.5rem">Detalle de Pago</h3>
            <div id="payroll-detail-info"
                style="margin-bottom: 2rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 12px; border-left: 4px solid var(--primary);">
                <!-- Employee info here -->
            </div>
            <div class="table-container">
                <table style="font-size: 0.9rem;">
                    <thead>
                        <tr>
                            <th title="Fecha del registro">Fecha</th>
                            <th title="Hora de entrada">Entrada</th>
                            <th title="Hora de salida">Salida</th>
                            <th title="Total de horas laboradas">Horas Totales</th>
                            <th title="Paga doble por feriado">¬øDoble?</th>
                            <th title="Horas de almuerzo rebajadas">Almuerzo</th>
                            <th title="Rebajo de CCSS">CCSS</th>
                            <th title="Origen del registro">Fuente</th>
                            <th title="Imagen capturada">Foto</th>
                            <th title="Monto neto a pagar">Monto Neto</th>
                        </tr>
                    </thead>
                    <tbody id="payroll-detail-body">
                        <!-- Log details here -->
                    </tbody>
                </table>
            </div>

            <!-- SECCI√ìN DE VALES / ADELANTOS -->
            <div style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <h4 style="color: var(--warning); margin-bottom: 1rem;"><i data-lucide="ticket"
                        style="width:18px; margin-right:8px; vertical-align:middle"></i> Vales y Adelantos Pendientes
                </h4>
                <div class="table-container"
                    style="background: rgba(245, 158, 11, 0.03); border: 1px solid rgba(245, 158, 11, 0.1); border-radius: 12px; padding: 10px;">
                    <table style="font-size: 0.85rem;">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Descripci√≥n</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="payroll-vouchers-body">
                            <!-- Vouchers here -->
                        </tbody>
                    </table>
                </div>

                <!-- Formulario r√°pido para agregar vale -->
                <div
                    style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px dashed rgba(255,255,255,0.1);">
                    <h5 style="margin-top: 0; margin-bottom: 10px; font-size: 0.85rem; color: var(--text-muted);"><i
                            data-lucide="plus" style="width:14px; margin-right:6px; vertical-align:middle"></i>
                        Agregar Nuevo Vale/Adelanto</h5>
                    <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 120px;">
                            <label
                                style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 5px;">Fecha</label>
                            <input type="date" id="new-voucher-date" style="padding: 6px; font-size: 0.85rem;">
                        </div>
                        <div style="flex: 2; min-width: 200px;">
                            <label
                                style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 5px;">Descripci√≥n</label>
                            <input type="text" id="new-voucher-desc" placeholder="Ej: Adelanto quincena"
                                style="padding: 6px; font-size: 0.85rem;">
                        </div>
                        <div style="flex: 1; min-width: 100px;">
                            <label
                                style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 5px;">Monto
                                (‚Ç°)</label>
                            <input type="number" id="new-voucher-amount" placeholder="0"
                                style="padding: 6px; font-size: 0.85rem;">
                        </div>
                        <button class="btn btn-primary" style="padding: 8px 15px; font-size: 0.85rem;"
                            id="add-voucher-btn">Agregar Vale</button>
                    </div>
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('payroll-detail-modal').close()">Cerrar</button>
            </div>
        </div>
    </dialog>

    <dialog id="whatsapp-confirm-modal" class="modal-small">
        <div class="modal-content">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div id="whatsapp-confirm-icon" style="margin-bottom: 0.5rem;"><i data-lucide="check-circle"
                        style="width:40px; height:40px; color: var(--success)"></i></div>
                <h3 id="whatsapp-confirm-title" style="color: var(--success);">WhatsApp Enviado</h3>
                <p id="whatsapp-confirm-subtitle" style="color: var(--text-muted); font-size: 0.9rem;">El resumen se ha
                    enviado correctamente.</p>
            </div>
            <div id="whatsapp-confirm-content"
                style="background: #075e54; color: white; padding: 1.5rem; border-radius: 12px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; white-space: pre-wrap; margin-bottom: 1.5rem; font-size: 0.95rem; line-height: 1.4; border-left: 4px solid #25d366;">
                <!-- Texto del mensaje aqu√≠ -->
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" style="flex: 1;"
                    onclick="document.getElementById('whatsapp-confirm-modal').close()">Aceptar</button>
            </div>
        </div>
    </dialog>

    <dialog id="payroll-success-modal" class="modal-small">
        <div class="modal-content" style="text-align: center;">
            <div style="margin-bottom: 1rem;"><i data-lucide="party-popper"
                    style="width:48px; height:48px; color: var(--success)"></i></div>
            <h3 style="color: var(--success); margin-bottom: 0.5rem;">¬°Planilla Registrada!</h3>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">El procesamiento se ha completado con √©xito.</p>

            <div id="payroll-success-summary"
                style="background: var(--hover-bg); padding: 1.5rem; border-radius: 16px; margin-bottom: 1.5rem; border-top: 4px solid var(--success);">
                <!-- Resumen inyectado aqu√≠ -->
            </div>

            <button class="btn btn-primary" style="width: 100%; padding: 12px;"
                onclick="document.getElementById('payroll-success-modal').close()">Entendido</button>
        </div>
    </dialog>

    <dialog id="business-modal">
        <div class="modal-content" style="max-width: 900px; max-height: 85vh; overflow-y: auto;">
            <button class="modal-close-btn" onclick="document.getElementById('business-modal').close()">‚úï</button>
            <h2 id="business-modal-title" style="margin-bottom: 2rem; color: var(--primary);">Gesti√≥n de Empresa</h2>
            <form id="business-form" class="form-grid">
                <input type="hidden" name="id" id="business-id">

                <!-- SECCI√ìN: INFORMACI√ìN DEL USUARIO (DUE√ëO) -->
                <div style="grid-column: span 2;">
                    <h3
                        style="color: var(--primary); font-size: 1.1rem; margin-bottom: 1.5rem; border-bottom: 2px solid rgba(99,102,241,0.2); padding-bottom: 8px;">
                        <i data-lucide="user" style="width:20px; margin-right:8px; vertical-align:middle"></i>
                        Informaci√≥n del Usuario (Due√±o)
                    </h3>
                </div>
                <div class="form-group">
                    <label>Nombre(s)</label>
                    <input type="text" name="ownerName" id="owner-name" placeholder="Ej: Juan" required>
                </div>
                <div class="form-group">
                    <label>Apellidos</label>
                    <input type="text" name="ownerLastName" id="owner-lastname" placeholder="Ej: P√©rez" required>
                </div>
                <div class="form-group">
                    <label>Correo Electr√≥nico (Ser√° su Usuario)</label>
                    <input type="email" name="ownerEmail" id="owner-email" placeholder="juan@ejemplo.com" required
                        oninput="document.getElementById('owner-username').value = this.value">
                </div>
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <div class="phone-input-group">
                        <select class="country-code-select" name="ownerPhonePrefix">
                            <option value="506" selected>üá®üá∑ +506</option>
                            <option value="507">üáµüá¶ +507</option>
                            <option value="505">üá≥üáÆ +505</option>
                            <option value="504">üá≠üá≥ +504</option>
                            <option value="502">üá¨üáπ +502</option>
                            <option value="503">üá∏üáª +503</option>
                            <option value="1">üá∫üá∏ +1</option>
                            <option value="52">üá≤üáΩ +52</option>
                            <option value="57">üá®üá¥ +57</option>
                            <option value="54">üá¶üá∑ +54</option>
                            <option value="56">üá®üá± +56</option>
                            <option value="51">üáµüá™ +51</option>
                            <option value="34">üá™üá∏ +34</option>
                        </select>
                        <input type="tel" name="ownerPhone" id="owner-phone" placeholder="Ej: 8888-8888" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Usuario (Login)</label>
                    <input type="text" name="ownerUsername" id="owner-username" placeholder="juan@ejemplo.com" readonly
                        style="background: rgba(255,255,255,0.02); opacity: 0.8;">
                </div>
                <div class="form-group">
                    <label>Contrase√±a (Nueva)</label>
                    <input type="password" name="ownerPassword" id="owner-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <!-- SECCI√ìN: INFORMACI√ìN DE LA EMPRESA (PARA INFORMES) -->
                <div style="grid-column: span 2; margin-top: 20px;">
                    <h3
                        style="color: var(--primary); font-size: 1.1rem; margin-bottom: 1.5rem; border-bottom: 2px solid rgba(99,102,241,0.2); padding-bottom: 8px;">
                        <i data-lucide="building-2" style="width:20px; margin-right:8px; vertical-align:middle"></i>
                        Informaci√≥n de la Empresa
                    </h3>
                </div>

                <div class="form-group">
                    <label>Nombre Comercial</label>
                    <input type="text" name="name" id="business-name" placeholder="Ej: Restaurante El Wok" required>
                </div>
                <div class="form-group">
                    <label>Tipo de Identidad</label>
                    <select name="legal_type" id="business-legal-type">
                        <option value="Persona Jur√≠dica">Persona Jur√≠dica</option>
                        <option value="Persona F√≠sica">Persona F√≠sica</option>
                        <option value="Sociedad An√≥nima (S.A.)">Sociedad An√≥nima (S.A.)</option>
                        <option value="Soc. Resp. Limitada (S.R.L.)">Soc. Resp. Limitada (S.R.L.)</option>
                        <option value="Fundaci√≥n / Asociaci√≥n">Fundaci√≥n / Asociaci√≥n</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Raz√≥n Social (Legal)</label>
                    <input type="text" name="legal_name" id="business-legal-name" placeholder="Nombre legal completo">
                </div>
                <div class="form-group">
                    <label id="label-cedula">C√©dula o Identificaci√≥n</label>
                    <input type="text" name="cedula_juridica" id="business-cedula" placeholder="Ej: 3-101-XXXXXX">
                </div>

                <div class="form-group">
                    <label>Pa√≠s</label>
                    <input type="text" name="country" id="business-country" value="Costa Rica">
                </div>
                <div class="form-group">
                    <label id="label-state">Provincia / Estado</label>
                    <input type="text" name="state" id="business-state">
                </div>
                <div class="form-group">
                    <label id="label-city">Cant√≥n / Ciudad</label>
                    <input type="text" name="city" id="business-city">
                </div>
                <div class="form-group">
                    <label id="label-district">Distrito / Barrio</label>
                    <input type="text" name="district" id="business-district">
                </div>
                <div class="form-group" style="grid-column: span 2">
                    <label>Direcci√≥n Exacta</label>
                    <textarea name="address" id="business-address" rows="2"
                        style="width: 100%; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 10px;"></textarea>
                </div>

                <!-- SECCI√ìN: CONFIGURACI√ìN SaaS -->
                <div style="grid-column: span 2; margin-top: 20px;">
                    <h3
                        style="color: var(--primary); font-size: 1.1rem; margin-bottom: 1.5rem; border-bottom: 2px solid rgba(99,102,241,0.2); padding-bottom: 8px;">
                        <i data-lucide="settings" style="width:20px; margin-right:8px; vertical-align:middle"></i>
                        Configuraci√≥n del Sistema
                    </h3>
                </div>
                <div class="form-group">
                    <label>Estado de Cuenta</label>
                    <select name="status" id="business-status">
                        <option value="Active">Activa</option>
                        <option value="Suspended">Suspendida (Bloqueada)</option>
                        <option value="Expired">Vencida</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tipo de Ciclo</label>
                    <select name="cycle_type" id="business-cycle">
                        <option value="Weekly">Semanal</option>
                        <option value="Biweekly">Quincenal</option>
                        <option value="Monthly">Mensual</option>
                    </select>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Logo de la Empresa</label>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <img src="" id="admin-business-logo-preview"
                            style="max-height: 50px; border-radius: 8px; background: rgba(255,255,255,0.05); display: none;">
                        <button type="button" class="btn btn-secondary" id="admin-logo-upload-btn"><i
                                data-lucide="upload" style="width:16px; margin-right:6px"></i> Subir
                            Logo</button>
                        <button type="button" class="btn btn-danger" id="admin-logo-remove-btn"
                            style="display: none; padding: 8px 12px;"><i data-lucide="trash-2"
                                style="width:16px; margin-right:6px"></i> Quitar Logo</button>
                        <input type="file" id="admin-logo-upload-input" accept="image/*" style="display: none;">
                        <input type="hidden" name="logo_url" id="business-logo">
                        <p style="font-size: 0.75rem; color: var(--text-muted); width: 100%;">M√°x 2MB. PNG, JPG, SVG. Si
                            no hay logo, se muestra el nombre.</p>
                    </div>
                </div>
                <div class="form-group">
                    <label>Pref. de Tema</label>
                    <select name="theme_preference" id="business-theme">
                        <option value="dark">Oscuro</option>
                        <option value="light">Claro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Vencimiento Accesso</label>
                    <input type="date" name="expires_at" id="business-expiry">
                </div>
                <div style="grid-column: span 2; display: flex; gap: 10px; margin-top: 30px;">
                    <button type="submit" class="btn btn-primary"
                        style="flex: 2; padding: 15px; font-weight: 600;">Guardar Todo</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1"
                        onclick="document.getElementById('business-modal').close()">Cerrar</button>
                </div>
            </form>
        </div>
    </dialog>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="main.js?v=27.0"></script>
    <!-- Modal para edici√≥n detallada de Log -->
    <dialog id="edit-log-modal" class="modal">
        <div class="modal-content" style="max-width: 700px">
            <button class="modal-close-btn" onclick="document.getElementById('edit-log-modal').close()">‚úï</button>
            <h3 id="edit-log-title" style="color: var(--primary); margin-bottom: 2rem">Editar Registro de Horas</h3>
            <form id="edit-log-form">
                <input type="hidden" name="logId">
                <div class="form-group">
                    <label>Fecha</label>
                    <input type="date" name="date" required>
                </div>
                <div class="grid-2" style="gap: 1rem">
                    <div class="form-group">
                        <label>Hora Entrada</label>
                        <input type="time" name="timeIn" required>
                    </div>
                    <div class="form-group">
                        <label>Hora Salida</label>
                        <input type="time" name="timeOut" required>
                    </div>
                </div>
                <div class="grid-2" style="gap: 1rem; margin-top: 1rem;">
                    <div class="form-group"
                        style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;">
                        <input type="checkbox" name="isDoubleDay" id="edit-log-double"
                            style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="edit-log-double" style="margin: 0; cursor: pointer;">D√≠a Doble</label>
                    </div>
                    <div class="form-group">
                        <label>Rebajos (Horas)</label>
                        <input type="number" name="deductionHours" step="0.1" min="0" value="0">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary" style="flex:1">Actualizar</button>
                    <button type="button" class="btn btn-secondary" style="flex:1"
                        onclick="document.getElementById('edit-log-modal').close()">Cancelar</button>
                </div>
            </form>
        </div>
    </dialog>

    <dialog id="user-modal" class="modal">
        <div class="modal-content" style="max-width: 500px">
            <button class="modal-close-btn" onclick="document.getElementById('user-modal').close()">‚úï</button>
            <h3 id="user-modal-title">Registrar Usuario</h3>
            <form id="user-form" style="display: flex; flex-direction: column; gap: 15px; margin-top: 1rem">
                <input type="hidden" name="id" id="user-id-input">
                <div class="form-group">
                    <label>Nombre Real</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Nombre de Usuario</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Rol</label>
                    <select name="role" id="user-role-select">
                        <option value="editor">Admin Editor (Solo Planillas)</option>
                        <option value="owner">Admin Due√±o (Control de Empresa)</option>
                        <option value="super_admin">Super Administrador (Global)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tel√©fono (Para copia de resumen WhatsApp)</label>
                    <div class="phone-input-group">
                        <select class="country-code-select" name="phone_prefix">
                            <option value="506" selected>üá®üá∑ +506</option>
                            <option value="507">üáµüá¶ +507</option>
                            <option value="505">üá≥üáÆ +505</option>
                            <option value="504">üá≠üá≥ +504</option>
                            <option value="502">üá¨üáπ +502</option>
                            <option value="503">üá∏üáª +503</option>
                            <option value="1">üá∫üá∏ +1</option>
                            <option value="52">üá≤üáΩ +52</option>
                            <option value="57">üá®üá¥ +57</option>
                            <option value="54">üá¶üá∑ +54</option>
                            <option value="56">üá®üá± +56</option>
                            <option value="51">üáµüá™ +51</option>
                            <option value="34">üá™üá∏ +34</option>
                        </select>
                        <input type="text" name="phone" placeholder="Ej: 88887777">
                    </div>
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <div class="password-wrapper">
                        <input type="password" name="password" placeholder="M√≠n. 6 caracteres">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex:1">Guardar</button>
                    <button type="button" class="btn btn-secondary" style="flex:1"
                        onclick="document.getElementById('user-modal').close()">Cerrar</button>
                </div>
            </form>
        </div>
    </dialog>
    <!-- Modal para Configuraci√≥n de Email -->
    <dialog id="email-notification-modal" class="modal-large">
        <div class="modal-content">
            <h2 id="email-modal-title" style="margin-bottom: 1.5rem">Editar Plantilla de Notificaci√≥n</h2>
            <form id="email-notification-form">
                <input type="hidden" name="id" id="email-config-id">
                <div class="form-group">
                    <label>Asunto del Correo</label>
                    <input type="text" name="subject" id="email-subject-input" required style="width: 100%">
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Usa {{variable}} para
                        insertar datos din√°micos.</p>
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <label>Destinatarios (Separados por coma)</label>
                    <input type="text" name="recipients" id="email-recipients-input" required style="width: 100%">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 1.5rem;">
                    <div class="form-group">
                        <label>Contenido HTML</label>
                        <textarea name="html_template" id="email-html-input" rows="15"
                            style="width: 100%; font-family: monospace; font-size: 0.85rem; background: var(--input-bg); color: var(--input-color); border: 1px solid var(--border); border-radius: 8px; padding: 10px;"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Vista Previa (Aproximada)</label>
                        <div id="email-preview-pane"
                            style="width: 100%; height: 320px; border: 1px solid var(--border); border-radius: 8px; background: white; overflow: auto; padding: 10px;">
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 1rem; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" name="is_active" id="email-active-checkbox" style="width: auto;">
                    <label for="email-active-checkbox">Notificaci√≥n Activada</label>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary" style="flex:1">Guardar Cambios</button>
                    <button type="button" class="btn btn-secondary" style="flex:1"
                        onclick="document.getElementById('email-notification-modal').close()">Cerrar</button>
                    <button type="button" class="btn" id="btn-test-email"
                        style="flex:1; background: #6366f1; color: white;">üì§ Enviar Prueba</button>
                </div>
            </form>
        </div>
    </dialog>


    <!-- Floating Support -->
    <div class="support-float" id="support-container">
        <div class="support-menu" id="support-menu">
            <a href="https://wa.me/50663602181" target="_blank" class="support-item">
                <span class="support-icon">üì±</span>
                <div class="support-text">
                    <strong>WhatsApp Soporte</strong>
                    <span>+506 6360-2181</span>
                </div>
            </a>
            <a href="mailto:info@avantixone.com" class="support-item">
                <span class="support-icon">üìß</span>
                <div class="support-text">
                    <strong>Correo Electr√≥nico</strong>
                    <span>info@avantixone.com</span>
                </div>
            </a>
        </div>
        <button class="support-btn" onclick="document.getElementById('support-container').classList.toggle('active')">
            <span class="btn-icon">üéß</span>
            <span class="btn-text">Soporte</span>
        </button>
    </div>
    <!-- Modal Gu√≠a de Instalaci√≥n iOS -->
    <dialog id="ios-install-modal" class="modal">
        <div class="modal-content" style="max-width: 400px; padding: 2.5rem;">
            <button class="modal-close-btn" onclick="document.getElementById('ios-install-modal').close()">‚úï</button>
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üçé</div>
                <h3 style="color: var(--primary); margin: 0;">Instalar en iPhone</h3>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">Siga estos pasos para
                    a√±adir la app a su inicio:</p>
            </div>

            <div class="ios-guide-step">
                <div class="ios-guide-icon">üì§</div>
                <div class="ios-guide-text">
                    Pulsa el icono de <strong>Compartir</strong> en la barra inferior de Safari.
                </div>
            </div>

            <div class="ios-guide-step">
                <div class="ios-guide-icon">‚ûï</div>
                <div class="ios-guide-text">
                    Desliza hacia abajo y selecciona <strong>"A√±adir a la pantalla de inicio"</strong>.
                </div>
            </div>

            <div class="ios-guide-step" style="margin-bottom: 0;">
                <div class="ios-guide-icon">‚úÖ</div>
                <div class="ios-guide-text">
                    Pulsa <strong>"A√±adir"</strong> en la esquina superior derecha.
                </div>
            </div>
        </div>
    </dialog>

    <script>
        // PWA Installation Logic
        let deferredPrompt;
        const pwaSection = document.getElementById('pwa-install-section');
        const installBtn = document.getElementById('btn-pwa-install');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir que el navegador lo muestre autom√°ticamente
            e.preventDefault();
            deferredPrompt = e;
            // Mostrar nuestro bot√≥n personalizado
            if (pwaSection) pwaSection.style.display = 'block';
        });

        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                // Detectar si es iOS
                const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches;

                if (isiOS) {
                    // Mostrar gu√≠a de iOS
                    document.getElementById('ios-install-modal').showModal();
                } else if (deferredPrompt) {
                    // Mostrar el prompt nativo (Android/Desktop)
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`PWA: Usuario eligi√≥ ${outcome}`);
                    deferredPrompt = null;
                    pwaSection.style.display = 'none';
                }
            });
        }

        // Mostrar bot√≥n en iOS si no est√° instalado
        window.addEventListener('load', () => {
            const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            if (isiOS && !isStandalone && pwaSection) {
                pwaSection.style.display = 'block';
                installBtn.innerHTML = '<span style="font-size: 1.2rem;">üçé</span> Instalar en iPhone / iPad';
            }
        });

        // Ocultar secci√≥n si ya est√° instalado
        if (window.matchMedia('(display-mode: standalone)').matches && pwaSection) {
            pwaSection.style.display = 'none';
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('PWA Service Worker registrado'))
                    .catch(err => console.log('PWA Service Worker fall√≥', err));
            });
        }
    </script>
</body>

</html>